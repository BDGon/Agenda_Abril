<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Aula Virtual Abril</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // TU CONFIGURACI√ìN EXACTA
    const firebaseConfig = {
      apiKey: "AIzaSyCHAbE43IMZuVIbXQF375HCrxAWaXUEyMk",
      authDomain: "agendadeabril.firebaseapp.com",
      projectId: "agendadeabril",
      storageBucket: "agendadeabril.firebasestorage.app",
      messagingSenderId: "150128924404",
      appId: "1:150128924404:web:23ad48fa674515721770a1"
    };

    // Inicializar
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Hacer accesibles las funciones de Firebase al resto del c√≥digo
    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.onSnapshot = onSnapshot;
    window.deleteDoc = deleteDoc;
    window.doc = doc;
    window.updateDoc = updateDoc;
    window.query = query;
    window.orderBy = orderBy;
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            violet: {
              50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd',
              400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9',
            }
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    .view { display: none; }
    .view.active { display: block; animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .feed-item::before {
      content: ''; position: absolute; left: 15px; top: 40px; bottom: -16px; width: 2px; background: #ddd6fe;
    }
    .feed-item:last-child::before { display: none; }
    #imageModal { touch-action: none; } 
    #modalImageFull { 
        transform-origin: center center; 
        transition: transform 0.1s ease-out; 
        touch-action: none;
    }
  </style>
</head>
<body class="bg-violet-50 min-h-screen pb-20">
  
  <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="processImage(this)">

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40 pb-safe">
    <div class="flex justify-around items-center h-16">
      <button onclick="showHome()" id="navHome" class="flex flex-col items-center gap-1 px-4 py-2 text-violet-600 transition-colors duration-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <span class="text-xs font-medium">Alumnos</span>
      </button>
      <button onclick="showAgenda()" id="navAgenda" class="flex flex-col items-center gap-1 px-4 py-2 text-gray-400 transition-colors duration-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <span class="text-xs font-medium">Agenda</span>
      </button>
    </div>
  </nav>

  <div id="homeView" class="view active">
    <header class="bg-white shadow-sm sticky top-0 z-30 pt-safe">
      <div class="px-4 py-5">
        <h1 class="text-2xl font-bold text-violet-700">Mis Alumnos</h1>
        <p class="text-violet-400 text-sm mt-1">Gesti√≥n de clases (Nube ‚òÅÔ∏è)</p>
      </div>
      <div class="px-4 pb-4">
        <div class="relative">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" id="searchInput" onkeyup="filterStudents()" placeholder="Buscar alumno..." 
            class="w-full pl-10 pr-4 py-3 bg-violet-50 border border-violet-100 rounded-xl focus:ring-2 focus:ring-violet-500 outline-none transition-all text-sm">
        </div>
      </div>
    </header>

    <main class="px-4 py-6">
      <div id="loadingIndicator" class="text-center text-violet-400 py-10">Cargando datos...</div>
      <div id="studentList" class="space-y-4"></div>
    </main>

    <button onclick="showAddStudentModal()" class="fixed bottom-20 right-6 w-14 h-14 bg-violet-600 hover:bg-violet-700 text-white rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-30">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
      </svg>
    </button>
  </div>

  <div id="detailView" class="view">
    <header class="bg-violet-600 text-white sticky top-0 z-30 pt-safe shadow-md">
      <div class="px-4 py-4">
        <button onclick="showHome()" class="flex items-center gap-2 text-violet-100 hover:text-white mb-3 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
          <span class="text-sm font-medium">Volver</span>
        </button>
        <div class="flex justify-between items-start">
            <div>
                <h1 id="studentName" class="text-2xl font-bold"></h1>
                <p id="studentSubject" class="text-violet-200 text-sm mt-1"></p>
            </div>
            <div class="flex gap-2">
                <button onclick="editCurrentStudent()" class="text-violet-200 hover:text-white text-sm bg-violet-700/50 px-3 py-1 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                </button>
                <button onclick="deleteCurrentStudent()" class="text-violet-200 hover:text-red-200 text-sm bg-violet-700/50 px-3 py-1 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>
        </div>
      </div>
    </header>

    <main class="px-4 py-6">
      <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 border border-gray-100">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-violet-100 rounded-xl flex items-center justify-center flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="font-semibold text-gray-800 mb-1">Direcci√≥n</h3>
            <p id="studentAddress" class="text-gray-500 text-sm mb-3"></p>
            <button onclick="openInMaps()" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-600 font-medium py-2 px-4 rounded-xl transition-colors flex items-center justify-center gap-2 border border-blue-200">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>
               Abrir en Google Maps
            </button>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-3 text-sm uppercase tracking-wide text-violet-500">Contacto</h3>
        <div class="space-y-3 text-sm">
          <div class="flex items-center gap-3">
            <span class="text-gray-400 w-16">Tel√©fono:</span>
            <a id="studentPhone" href="#" class="text-violet-600 font-medium hover:underline"></a>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-gray-400 w-16">Tutor:</span>
            <span id="studentParent" class="text-gray-700 font-medium"></span>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-violet-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
          Material y Notas
        </h3>
        
        <div class="bg-violet-50 rounded-xl p-3 mb-6">
          <textarea id="feedNoteInput" placeholder="Escribe un progreso o nota de la clase..." rows="2" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-violet-500 outline-none resize-none mb-3"></textarea>
          <div class="flex gap-2">
             <button onclick="document.getElementById('imageInput').click()" class="flex-1 bg-white border border-violet-200 text-violet-600 py-2 px-3 rounded-lg text-sm font-medium hover:bg-violet-50 flex items-center justify-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Foto
             </button>
             
             <button onclick="attachLink()" class="flex-1 bg-white border border-violet-200 text-violet-600 py-2 px-3 rounded-lg text-sm font-medium hover:bg-violet-50 flex items-center justify-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                Link
             </button>
          </div>
          <button onclick="addFeedNote()" class="w-full mt-2 bg-violet-600 text-white py-2 px-3 rounded-lg text-sm font-medium hover:bg-violet-700 shadow-sm">
             Guardar Nota
          </button>
        </div>
        
        <div id="materialFeed" class="space-y-0"></div>
      </div>
    </main>
  </div>

  <div id="agendaView" class="view">
    <header class="bg-white shadow-sm sticky top-0 z-30 pt-safe">
      <div class="px-4 py-5">
        <h1 class="text-2xl font-bold text-violet-700">¬øA qui√©n veo hoy?</h1>
        <p class="text-violet-400 text-sm mt-1">Horario semanal de clases</p>
      </div>
    </header>
    <main class="px-4 py-6">
      <div id="weeklySchedule" class="space-y-4"></div>
    </main>
    <button onclick="showAddClassModal()" class="fixed bottom-20 right-6 w-14 h-14 bg-violet-600 hover:bg-violet-700 text-white rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-30">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
      </svg>
    </button>
  </div>

  <div id="addStudentModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl transform transition-all">
      <h2 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4">Nuevo Alumno</h2>
      <form id="addStudentForm" class="space-y-3">
        <input type="text" id="newStudentName" required placeholder="Nombre completo" class="w-full border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-violet-500 outline-none">
        <input type="text" id="newStudentSubject" required placeholder="Materia (ej. Matem√°ticas)" class="w-full border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-violet-500 outline-none">
        <input type="text" id="newStudentAddress" placeholder="Direcci√≥n exacta (para el mapa)" class="w-full border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-violet-500 outline-none">
        <input type="tel" id="newStudentPhone" placeholder="Tel√©fono" class="w-full border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-violet-500 outline-none">
        <input type="text" id="newStudentParent" placeholder="Nombre del Padre/Tutor" class="w-full border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-violet-500 outline-none">
        
        <div class="flex gap-3 pt-2">
          <button type="button" onclick="hideAddStudentModal()" class="flex-1 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl">Cancelar</button>
          <button type="submit" class="flex-1 bg-violet-600 text-white font-medium py-3 rounded-xl hover:bg-violet-700 shadow-lg shadow-violet-200">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="addClassModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
      <h2 id="classModalTitle" class="text-xl font-bold text-gray-800 mb-4">Agendar Clase</h2>
      <form id="addClassForm" class="space-y-3">
        <div>
            <label class="text-xs font-bold text-gray-500 ml-1">Alumno</label>
            <select id="classStudent" required class="w-full border border-gray-200 rounded-xl px-4 py-3 bg-white focus:ring-2 focus:ring-violet-500 outline-none"></select>
        </div>
        <div>
            <label class="text-xs font-bold text-gray-500 ml-1">D√≠a</label>
            <select id="classDay" required class="w-full border border-gray-200 rounded-xl px-4 py-3 bg-white focus:ring-2 focus:ring-violet-500 outline-none">
                <option value="0">Lunes</option><option value="1">Martes</option><option value="2">Mi√©rcoles</option><option value="3">Jueves</option><option value="4">Viernes</option>
            </select>
        </div>
        <div class="flex gap-3">
            <div class="flex-1">
                <label class="text-xs font-bold text-gray-500 ml-1">Hora</label>
                <input type="time" id="classTime" required class="w-full border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-violet-500 outline-none">
            </div>
            <div class="flex-1">
                <label class="text-xs font-bold text-gray-500 ml-1">Duraci√≥n</label>
                <select id="classDuration" class="w-full border border-gray-200 rounded-xl px-4 py-3 bg-white focus:ring-2 focus:ring-violet-500 outline-none">
                    <option value="60">1 hora</option><option value="90">1.5 horas</option><option value="120">2 horas</option>
                </select>
            </div>
        </div>
        
        <div class="flex items-center gap-3 p-3 bg-violet-50 rounded-xl">
          <input type="checkbox" id="repeatWeekly" checked class="w-5 h-5 text-violet-600 rounded focus:ring-violet-500">
          <label for="repeatWeekly" class="text-sm text-gray-700 font-medium">Repetir todas las semanas</label>
        </div>

        <div class="flex gap-3 pt-2">
          <button type="button" onclick="hideAddClassModal()" class="flex-1 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl">Cancelar</button>
          <button type="submit" class="flex-1 bg-violet-600 text-white font-medium py-3 rounded-xl hover:bg-violet-700 shadow-lg shadow-violet-200">Agendar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="imageModal" class="fixed inset-0 bg-black z-[60] hidden overflow-hidden justify-center items-center">
    <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white bg-black/50 hover:bg-white/20 rounded-full p-3 transition-colors z-[70]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
    </button>
    <div id="modalImageContainer" class="w-full h-full flex items-center justify-center overflow-hidden">
        <img id="modalImageFull" src="" class="max-w-full max-h-full object-contain">
    </div>
  </div>

  <script type="module">
    // VARIABLES GLOBALES
    let students = [];
    let weeklySchedule = [];
    let currentStudentId = null;
    let editingClassId = null;

    // --- ESCUCHADORES EN TIEMPO REAL (SYNC AUTOM√ÅTICO) ---
    function setupListeners() {
        // Escuchar cambios en la colecci√≥n 'students'
        const qStudents = window.query(window.collection(window.db, "students"), window.orderBy("name"));
        window.onSnapshot(qStudents, (snapshot) => {
            students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Ocultar indicador de carga si existe
            const loader = document.getElementById('loadingIndicator');
            if(loader) loader.style.display = 'none';
            
            window.renderStudentList();
            
            // Si estamos viendo un perfil y se actualiza (ej. otro dispositivo sube foto), refrescar
            if(currentStudentId) {
                const updatedStudent = students.find(s => s.id === currentStudentId);
                if(updatedStudent) showStudentDetail(updatedStudent);
            }
        });

        // Escuchar cambios en la colecci√≥n 'schedule'
        const qSchedule = window.query(window.collection(window.db, "schedule"));
        window.onSnapshot(qSchedule, (snapshot) => {
            weeklySchedule = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window.renderWeeklySchedule();
        });
    }

    // Arrancar la app (esperamos un poco a que cargue Firebase)
    setTimeout(setupListeners, 500);

    // --- FUNCIONES L√ìGICAS (EXPUESTAS A WINDOW PARA EL HTML) ---

    // 1. RENDERIZADO DE ALUMNOS
    window.renderStudentList = function() {
        const container = document.getElementById('studentList');
        // Usar la variable local 'students'
        const data = students; 
        
        if (data.length === 0) {
            container.innerHTML = `<div class="text-center py-12 opacity-50"><p>No hay alumnos a√∫n.</p><p class="text-sm">Toca el bot√≥n + para empezar.</p></div>`;
            return;
        }
        
        // Filtro de b√∫squeda si hay texto
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = data.filter(s => s.name.toLowerCase().includes(term) || s.subject.toLowerCase().includes(term));

        container.innerHTML = filtered.map(s => `
            <div class="bg-white rounded-2xl shadow-sm p-4 flex items-center gap-4 border-l-4 border-violet-500 cursor-pointer" onclick="openStudent('${s.id}')">
                <div class="w-12 h-12 bg-violet-100 rounded-full flex items-center justify-center text-violet-700 font-bold text-lg">
                    ${getInitials(s.name)}
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-800">${s.name}</h3>
                    <p class="text-xs text-violet-500 font-medium uppercase">${s.subject}</p>
                </div>
                <button class="text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        `).join('');
    }

    window.filterStudents = function() {
        window.renderStudentList();
    }

    window.openStudent = function(id) {
        currentStudentId = id;
        const student = students.find(s => s.id === id);
        if(student) showStudentDetail(student);
    }

    function showStudentDetail(student) {
        document.getElementById('studentName').innerText = student.name;
        document.getElementById('studentSubject').innerText = student.subject;
        document.getElementById('studentAddress').innerText = student.address || "Sin direcci√≥n";
        document.getElementById('studentPhone').innerText = student.phone || "---";
        document.getElementById('studentPhone').href = student.phone ? `tel:${student.phone}` : "#";
        document.getElementById('studentParent').innerText = student.parent || "---";
        
        renderMaterialFeed(student);
        
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('detailView').classList.add('active');
        window.scrollTo(0,0);
    }

    // 2. GUARDAR / EDITAR ALUMNO (FIREBASE)
    window.addStudentFormSubmit = async function(e) {
        e.preventDefault();
        const data = {
            name: document.getElementById('newStudentName').value,
            subject: document.getElementById('newStudentSubject').value,
            address: document.getElementById('newStudentAddress').value,
            phone: document.getElementById('newStudentPhone').value,
            parent: document.getElementById('newStudentParent').value,
            materials: [] // Inicializar array vac√≠o si es nuevo
        };

        try {
            if(currentStudentId && document.getElementById('modalTitle').innerText.includes("Editar")) {
                // Actualizar existente
                await window.updateDoc(window.doc(window.db, "students", currentStudentId), {
                    name: data.name,
                    subject: data.subject,
                    address: data.address,
                    phone: data.phone,
                    parent: data.parent
                });
            } else {
                // Crear nuevo
                await window.addDoc(window.collection(window.db, "students"), data);
            }
            window.hideAddStudentModal();
            e.target.reset();
        } catch (error) {
            console.error("Error guardando alumno:", error);
            alert("Error al guardar. Verifica tu conexi√≥n.");
        }
    }

    // 3. MATERIALES (NOTAS, FOTOS) EN FIREBASE
    function renderMaterialFeed(student) {
        const feed = document.getElementById('materialFeed');
        feed.innerHTML = "";
        
        const materials = student.materials || [];
        if(materials.length === 0) {
            feed.innerHTML = `<p class="text-center text-gray-400 text-sm py-4">Sin notas a√∫n.</p>`;
            return;
        }

        // Ordenar por fecha descendente
        const sorted = [...materials].sort((a,b) => b.createdAt - a.createdAt);

        sorted.forEach(item => {
            let icon = 'üìù'; 
            let contentHtml = '';
            let colorClass = "border-l-4 border-violet-400";
            let typeLabel = "NOTA";

            if(item.type === 'link') {
                icon = 'üîó';
                typeLabel = "LINK";
                colorClass = "border-l-4 border-blue-400";
                contentHtml = `
                    <p class="text-gray-800 font-medium mb-1">${item.title || 'Enlace adjunto'}</p>
                    <a href="${item.content}" target="_blank" class="text-blue-600 hover:underline text-xs break-all flex items-center gap-1">
                        Abrir recurso
                    </a>
                `;
            } else if (item.type === 'image') {
                icon = 'üì∑';
                typeLabel = "FOTO";
                colorClass = "border-l-4 border-pink-400";
                contentHtml = `
                    <div class="rounded-lg overflow-hidden border border-gray-200 mt-1 cursor-pointer hover:opacity-90 transition-opacity" onclick="openImageModal('${item.content}')">
                        <img src="${item.content}" alt="Foto" class="w-full h-auto object-cover max-h-48">
                    </div>
                `;
            } else {
                contentHtml = `<p class="text-gray-700">${item.content}</p>`;
            }

            const date = new Date(item.createdAt).toLocaleDateString();
            
            feed.innerHTML += `
                <div class="feed-item relative pl-8 pb-6">
                    <div class="absolute left-0 top-0 w-8 h-8 bg-white border border-gray-200 rounded-full flex items-center justify-center text-sm shadow-sm z-10">
                        ${icon}
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 ${colorClass}">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">${typeLabel}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-gray-400">${date}</span>
                                <button onclick="deleteMaterialItem(${item.createdAt})" class="text-gray-300 hover:text-red-500 transition-colors p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm">${contentHtml}</div>
                    </div>
                </div>
            `;
        });
    }

    // Funciones para agregar items al array 'materials' en Firestore
    window.addFeedNote = async function() {
        if(!currentStudentId) return;
        const txt = document.getElementById('feedNoteInput').value.trim();
        if(!txt) return;
        
        const newItem = { type: 'note', content: txt, createdAt: Date.now() };
        await updateStudentMaterials(newItem);
        document.getElementById('feedNoteInput').value = "";
    }

    window.processImage = function(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 600; // Reducimos para optimizar espacio en Firestore
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                    
                    if(currentStudentId) {
                        const newItem = { type: 'image', content: dataUrl, createdAt: Date.now() };
                        updateStudentMaterials(newItem);
                    }
                }
            }
            reader.readAsDataURL(file);
        }
        input.value = '';
    }

    window.attachLink = async function() {
        const url = prompt("Pega aqu√≠ el enlace:");
        if(url && currentStudentId) {
            const name = prompt("Nombre del enlace:", "Enlace");
            const newItem = { type: 'link', content: url, title: name || 'Link', createdAt: Date.now() };
            updateStudentMaterials(newItem);
        }
    }

    // Funci√≥n auxiliar para actualizar el array en Firestore
    async function updateStudentMaterials(newItem) {
        const studentRef = window.doc(window.db, "students", currentStudentId);
        const student = students.find(s => s.id === currentStudentId);
        // Crear nuevo array con el item agregado
        const newMaterials = [...(student.materials || []), newItem];
        
        await window.updateDoc(studentRef, { materials: newMaterials });
    }

    window.deleteMaterialItem = async function(createdAt) {
        if(confirm("¬øSeguro que quieres borrar este elemento?") && currentStudentId) {
            const studentRef = window.doc(window.db, "students", currentStudentId);
            const student = students.find(s => s.id === currentStudentId);
            // Filtrar para quitar el item
            const newMaterials = student.materials.filter(m => m.createdAt !== createdAt);
            
            await window.updateDoc(studentRef, { materials: newMaterials });
        }
    }

    // 4. CLASES Y HORARIOS (FIREBASE)
    window.addClassFormSubmit = async function(e) {
        e.preventDefault();
        const sId = document.getElementById('classStudent').value;
        const day = parseInt(document.getElementById('classDay').value);
        const time = document.getElementById('classTime').value;
        const duration = parseInt(document.getElementById('classDuration').value);

        // Validaci√≥n duplicados (Usando weeklySchedule que viene de la nube)
        const duplicate = weeklySchedule.find(c => 
            c.dayOfWeek == day && 
            c.time == time && 
            c.studentId == sId && 
            c.id !== editingClassId
        );

        if(duplicate) {
            alert("¬°Cuidado! Este alumno ya tiene una clase agendada ese d√≠a a esa hora.");
            return;
        }

        const data = {
            studentId: sId,
            dayOfWeek: day,
            time: time,
            duration: duration,
            recurring: true
        };

        if (editingClassId) {
            await window.updateDoc(window.doc(window.db, "schedule", editingClassId), data);
        } else {
            await window.addDoc(window.collection(window.db, "schedule"), data);
        }
        
        window.hideAddClassModal();
    }

    window.deleteClass = async function(classId) {
        if(confirm("¬øSeguro que quieres eliminar esta clase?")) {
            await window.deleteDoc(window.doc(window.db, "schedule", classId));
        }
    }

    window.editClass = function(classId) {
        const cls = weeklySchedule.find(c => c.id === classId);
        if(!cls) return;

        // Llenar datos en el modal
        const select = document.getElementById('classStudent');
        select.innerHTML = students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        select.value = cls.studentId;
        
        document.getElementById('classDay').value = cls.dayOfWeek;
        document.getElementById('classTime').value = cls.time;
        document.getElementById('classDuration').value = cls.duration;

        editingClassId = classId;
        document.getElementById('classModalTitle').innerText = "Editar Clase";
        
        document.getElementById('addClassModal').classList.remove('hidden');
        document.getElementById('addClassModal').classList.add('flex');
    }

    window.renderWeeklySchedule = function() {
        const container = document.getElementById('weeklySchedule');
        const days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];
        const todayIndex = new Date().getDay() - 1;
        let html = "";
        days.forEach((dayName, i) => {
            const classes = weeklySchedule.filter(c => c.dayOfWeek == i).sort((a,b) => a.time.localeCompare(b.time));
            const headerClass = (i === todayIndex) ? "bg-violet-600 text-white shadow-md" : "bg-gray-100 text-gray-600";
            html += `
                <div class="rounded-xl overflow-hidden border border-gray-100 mb-4">
                    <div class="px-4 py-2 ${headerClass} flex justify-between items-center"><span class="font-bold text-sm">${dayName}</span>${(i === todayIndex) ? '<span class="text-[10px] bg-white/20 px-2 rounded-full">HOY</span>' : ''}</div>
                    <div class="bg-white p-2">${classes.length === 0 ? '<p class="text-xs text-gray-300 text-center py-2">Libre</p>' : classes.map(c => {
                        const st = students.find(s => s.id === c.studentId);
                        if(!st) return ''; 
                        return `
                            <div class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg border-b border-gray-50 group">
                                <div class="text-center min-w-[50px]"><p class="font-bold text-gray-800 text-sm">${c.time}</p><p class="text-[10px] text-gray-400">${c.duration} min</p></div>
                                <div class="flex-1"><p class="font-medium text-gray-800 text-sm">${st.name}</p><p class="text-xs text-violet-500">${st.subject}</p></div>
                                <div class="flex gap-2"><button onclick="editClass('${c.id}')" class="text-gray-300 hover:text-violet-600">‚úé</button><button onclick="deleteClass('${c.id}')" class="text-gray-300 hover:text-red-500">üóë</button></div>
                            </div>`;
                    }).join('')}</div>
                </div>`;
        });
        container.innerHTML = html;
    }

    // 5. EDICI√ìN Y BORRADO DE ALUMNO
    window.editCurrentStudent = function() {
        if(!currentStudentId) return;
        const s = students.find(x => x.id === currentStudentId);
        document.getElementById('newStudentName').value = s.name;
        document.getElementById('newStudentSubject').value = s.subject;
        document.getElementById('newStudentAddress').value = s.address;
        document.getElementById('newStudentPhone').value = s.phone;
        document.getElementById('newStudentParent').value = s.parent;
        
        document.getElementById('modalTitle').innerText = "Editar Alumno";
        document.getElementById('addStudentModal').classList.remove('hidden');
        document.getElementById('addStudentModal').classList.add('flex');
    }

    window.deleteCurrentStudent = async function() {
        if(confirm("ADVERTENCIA: Se borrar√° el alumno y todo su historial de la nube. ¬øEst√°s seguro?") && currentStudentId) {
            await window.deleteDoc(window.doc(window.db, "students", currentStudentId));
            
            // Opcional: Limpiar sus clases del horario
            const classesToDelete = weeklySchedule.filter(c => c.studentId === currentStudentId);
            classesToDelete.forEach(c => window.deleteDoc(window.doc(window.db, "schedule", c.id)));
            
            window.showHome();
        }
    }

    // AUXILIARES
    function getInitials(name) { return name ? name.substring(0,2).toUpperCase() : "??"; }
    
    // Conectar Event Listeners a las funciones globales
    document.getElementById('addStudentForm').addEventListener('submit', window.addStudentFormSubmit);
    document.getElementById('addClassForm').addEventListener('submit', window.addClassFormSubmit);

    // Funciones UI (Navegaci√≥n y Modales)
    window.showHome = function() { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById('homeView').classList.add('active'); document.getElementById('navHome').classList.add('text-violet-600'); document.getElementById('navAgenda').classList.remove('text-violet-600'); }
    window.showAgenda = function() { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById('agendaView').classList.add('active'); document.getElementById('navHome').classList.remove('text-violet-600'); document.getElementById('navAgenda').classList.add('text-violet-600'); window.renderWeeklySchedule(); }
    
    window.showAddStudentModal = function() { 
        currentStudentId = null; 
        document.getElementById('modalTitle').innerText = "Nuevo Alumno";
        document.getElementById('addStudentModal').classList.remove('hidden'); 
        document.getElementById('addStudentModal').classList.add('flex'); 
    }
    window.hideAddStudentModal = function() { document.getElementById('addStudentModal').classList.add('hidden'); document.getElementById('addStudentModal').classList.remove('flex'); }
    
    window.showAddClassModal = function() {
        editingClassId = null;
        document.getElementById('classModalTitle').innerText = "Agendar Clase";
        document.getElementById('addClassForm').reset();
        
        const select = document.getElementById('classStudent');
        select.innerHTML = students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        if(students.length===0) return alert("Primero crea un alumno.");
        
        document.getElementById('addClassModal').classList.remove('hidden');
        document.getElementById('addClassModal').classList.add('flex');
    }
    window.hideAddClassModal = function() { document.getElementById('addClassModal').classList.add('hidden'); document.getElementById('addClassModal').classList.remove('flex'); }

    window.openInMaps = function() {
        const student = students.find(s => s.id === currentStudentId);
        if(!student || !student.address) return alert("Agrega una direcci√≥n primero.");
        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(student.address)}`;
        window.open(url, '_blank');
    }

    // ZOOM Y EVENTOS
    let scale = 1, currentScale = 1, pointX = 0, pointY = 0, startX = 0, startY = 0, isDragging = false, initialDistance = 0;
    const modalImage = document.getElementById('modalImageFull');
    const modalContainer = document.getElementById('imageModal');

    window.openImageModal = function(url) { modalImage.src = url; modalContainer.classList.remove('hidden'); modalContainer.classList.add('flex'); resetZoom(); }
    window.closeImageModal = function() { modalContainer.classList.add('hidden'); modalContainer.classList.remove('flex'); setTimeout(() => { modalImage.src = ''; }, 200); }
    function resetZoom() { scale = 1; pointX = 0; pointY = 0; updateTransform(); }
    function updateTransform() { modalImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }

    modalImage.addEventListener('touchstart', (e) => { if (e.touches.length === 2) { isDragging = false; initialDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); currentScale = scale; } else if (e.touches.length === 1) { isDragging = true; startX = e.touches[0].pageX - pointX; startY = e.touches[0].pageY - pointY; } });
    modalImage.addEventListener('touchmove', (e) => { e.preventDefault(); if (e.touches.length === 2) { const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); scale = Math.min(Math.max(1, currentScale * (dist / initialDistance)), 4); updateTransform(); } else if (e.touches.length === 1 && isDragging && scale > 1) { pointX = e.touches[0].pageX - startX; pointY = e.touches[0].pageY - startY; updateTransform(); } });
    modalImage.addEventListener('touchend', (e) => { isDragging = false; if (scale < 1.1) resetZoom(); });
    let lastTap = 0;
    modalImage.addEventListener('touchend', (e) => { const currentTime = new Date().getTime(); const tapLength = currentTime - lastTap; if (tapLength < 300 && tapLength > 0) { if (scale > 1) resetZoom(); else { scale = 2; updateTransform(); } } lastTap = currentTime; });

    window.onclick = function(e) { 
        if (e.target.id === 'addStudentModal') hideAddStudentModal();
        if (e.target.id === 'addClassModal') hideAddClassModal();
        if (e.target.id === 'imageModal') closeImageModal();
    }
  </script>
</body>
</html>
